<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDGDRDC - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1 class="logo">游늵 SDGDRDC - Dashboard</h1>
    </header>
    <main>
        <section class="container" aria-live="polite">
            <div class="header-actions">
                <button onclick="window.location.href='/'" class="btn btn-small btn-warning" aria-label="Volver a la p치gina principal">游댗 Volver</button>
            </div>
            
            <div id="alertContainer" role="alert"></div>
            
            <section class="stats-section" id="statsGrid">
                <div class="loading" id="loading" aria-live="polite">Cargando estad칤sticas...</div>
                <div id="statsCards"></div>
                <canvas id="vulnerabilityChart" style="display: none; max-height: 400px;"></canvas>
            </section>
        </section>
    </main>

    <script>
        let dashboardChart = null;

        // Funci칩n para verificar autenticaci칩n
        async function checkAuth() {
            console.log('Checking authentication at', new Date().toLocaleString());
            if (!window.token) {
                console.log('No token found, redirecting to login at', new Date().toLocaleString());
                showAlert('Por favor, inicie sesi칩n primero.', 'danger');
                setTimeout(() => window.location.href = '/', 2000);
                return false;
            }
            try {
                const response = await fetch('/api/verify-token', {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                console.log('Auth check response:', response.status, 'at', new Date().toLocaleString());
                if (response.status === 401) {
                    console.log('Token invalid, clearing and redirecting at', new Date().toLocaleString());
                    showAlert('Sesi칩n expirada, redirigiendo al login.', 'danger');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/', 2000);
                    return false;
                }
                const data = await response.json();
                if (!data.valid) {
                    console.log('Token validation failed, redirecting at', new Date().toLocaleString());
                    showAlert('Sesi칩n inv치lida, redirigiendo al login.', 'danger');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/', 2000);
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error verifying token:', error, 'at', new Date().toLocaleString());
                showAlert('Error al verificar la sesi칩n. Redirigiendo.', 'danger');
                setTimeout(() => window.location.href = '/', 2000);
                return false;
            }
        }

        // Funci칩n para mostrar alertas
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            if (alertContainer) {
                alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alertContainer.innerHTML = '', 5000);
            }
        }

        // Funci칩n para cargar estad칤sticas del dashboard
        async function loadDashboardStats() {
            console.log('Loading dashboard stats at', new Date().toLocaleString());
            const loading = document.getElementById('loading');
            const statsCards = document.getElementById('statsCards');
            const chartCanvas = document.getElementById('vulnerabilityChart');

            if (!loading || !statsCards || !chartCanvas) {
                console.error('DOM elements not found at', new Date().toLocaleString());
                showAlert('Error al cargar la p치gina. Recargue o contacte al administrador.', 'danger');
                return;
            }

            if (!await checkAuth()) return;

            loading.style.display = 'block';
            statsCards.innerHTML = '';
            chartCanvas.style.display = 'none';

            try {
                const response = await fetch('/api/vulnerabilidades', {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                console.log('Vulnerabilities fetch response:', response.status, 'at', new Date().toLocaleString());
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const vulnerabilities = await response.json();

                if (!Array.isArray(vulnerabilities) || vulnerabilities.length === 0) {
                    throw new Error('No se encontraron datos de vulnerabilidades v치lidos');
                }

                const stats = {
                    total: vulnerabilities.length,
                    byProtocol: vulnerabilities.reduce((acc, v) => {
                        const protocolo = v.protocolo_nombre || 'Desconocido';
                        acc[protocolo] = (acc[protocolo] || 0) + 1;
                        return acc;
                    }, {}),
                    byCriticidad: vulnerabilities.reduce((acc, v) => {
                        const criticidad = v.criticidad_nombre || 'Sin asignar';
                        acc[criticidad] = (acc[criticidad] || 0) + 1;
                        return acc;
                    }, {})
                };

                // Generar tarjetas de estad칤sticas
                const protocolsToShow = ['SMB', 'TLS', 'SSL', 'HTTP', 'FTP'];
                const criticidadesToShow = ['Baja', 'Media', 'Alta', 'Cr칤tica', 'Sin asignar'];
                const cardsHTML = `
                    <div class="stat-card"><h3>Total Vulnerabilidades</h3><p>${stats.total}</p></div>
                    ${protocolsToShow.map(p => `<div class="stat-card"><h3>${p}</h3><p>${stats.byProtocol[p] || 0}</p></div>`).join('')}
                    ${criticidadesToShow.map(c => `<div class="stat-card"><h3>${c}</h3><p>${stats.byCriticidad[c] || 0}</p></div>`).join('')}
                `;
                statsCards.innerHTML = cardsHTML;

                // Renderizar gr치fico
                const ctx = chartCanvas.getContext('2d');
                if (dashboardChart) {
                    dashboardChart.destroy();
                }
                dashboardChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(stats.byProtocol),
                        datasets: [{
                            label: 'Vulnerabilidades por Protocolo',
                            data: Object.values(stats.byProtocol),
                            backgroundColor: ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8'],
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'N칰mero de Vulnerabilidades' } },
                            x: { title: { display: true, text: 'Protocolos' } }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: { enabled: true }
                        }
                    }
                });
                chartCanvas.style.display = 'block';

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading dashboard stats:', error, 'at', new Date().toLocaleString());
                loading.style.display = 'none';
                statsCards.innerHTML = '<p>No se pudieron cargar las estad칤sticas.</p>';
                chartCanvas.style.display = 'none';
                if (error.message.includes('401')) {
                    showAlert('Sesi칩n expirada, redirigiendo al login.', 'danger');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/', 2000);
                } else {
                    showAlert('Error al cargar las estad칤sticas. Intente de nuevo.', 'danger');
                }
            }
        }

        // Inicializar cuando se cargue din치micamente
        function initializeDashboard() {
            console.log('Initializing dashboard at', new Date().toLocaleString());
            loadDashboardStats();
            setInterval(loadDashboardStats, 60000); // Refresca cada 60 segundos
        }

        // Ejecutar inicializaci칩n si se carga directamente o din치micamente
        if (window.self === window.top) {
            initializeDashboard();
        } else {
            const checkReady = setInterval(() => {
                if (document.getElementById('loading') && document.getElementById('statsCards') && document.getElementById('vulnerabilityChart')) {
                    clearInterval(checkReady);
                    initializeDashboard();
                }
            }, 100);
        }
    </script>
</body>
</html>