<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDGDRDC - GestiÃ³n de Vulnerabilidades</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- SecciÃ³n de Login -->
    <div class="container" id="loginSection">
        <h1>ğŸ” SDGDRDC - Inicio de SesiÃ³n</h1>
        <div class="login-section">
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="loginEmail">ğŸ“§ Email:</label>
                <input type="email" id="loginEmail" value="admin@uniminuto.edu" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">ğŸ”‘ ContraseÃ±a:</label>
                <input type="password" id="loginPassword" value="admin123" required>
            </div>
            <button onclick="login()">ğŸš€ Iniciar SesiÃ³n</button>
            <div style="margin-top: 10px;">
                <small>Estado del servidor: <span class="status-indicator" id="serverStatus"></span><span id="serverStatusText">Verificando...</span></small>
            </div>
        </div>
    </div>

    <!-- SecciÃ³n Principal -->
    <div class="container hidden" id="mainSection">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>ğŸ“Š SDGDRDC - Sistema de GestiÃ³n de Riesgos de Conectividad</h1>
            <div>
                <button onclick="window.location.href='/dashboard'" class="btn btn-small btn-warning">ğŸ“ˆ Dashboard</button>
                <button onclick="window.location.href='/reports'" class="btn btn-small btn-warning">ğŸ“‹ Reportes</button>
                <button onclick="logout()" class="btn btn-danger">ğŸšª Cerrar SesiÃ³n</button>
            </div>
        </div>
        
        <div id="alertContainer"></div>
        
        <h2>â• Crear/Actualizar Vulnerabilidad</h2>
        <form id="vulnerabilidadForm">
            <div class="form-group">
                <label for="id_protocolo">ğŸ”— Protocolo:</label>
                <select name="id_protocolo" id="id_protocolo" required>
                    <option value="">Seleccionar protocolo...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="id_criticidad">âš ï¸ Criticidad:</label>
                <select name="id_criticidad" id="id_criticidad" required>
                    <option value="">Seleccionar criticidad...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="id_estado">ğŸ“‹ Estado:</label>
                <select name="id_estado" id="id_estado" required>
                    <option value="">Seleccionar estado...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="descripcion">ğŸ“ DescripciÃ³n:</label>
                <textarea name="descripcion" id="descripcion" maxlength="500" placeholder="Describa detalladamente (mÃ¡x. 500 caracteres)..." required></textarea>
            </div>
            <div class="form-group">
                <label for="fecha_identificacion">ğŸ“… Fecha de IdentificaciÃ³n:</label>
                <input type="date" name="fecha_identificacion" id="fecha_identificacion" required>
            </div>
            <div class="form-group">
                <label for="responsable">ğŸ‘¤ Responsable:</label>
                <input type="text" name="responsable" id="responsable" maxlength="100">
            </div>
            <div class="form-group">
                <label for="id_usuario_asignado">ğŸ‘¥ Usuario Asignado:</label>
                <select name="id_usuario_asignado" id="id_usuario_asignado">
                    <option value="">Sin asignar</option>
                </select>
            </div>
            <button type="submit">ğŸš€ Crear/Actualizar Vulnerabilidad</button>
        </form>

        <div class="container" id="vulnerabilidadesSection">
            <h2>ğŸ“Š Lista de Vulnerabilidades</h2>
            <div class="loading" id="loading">Cargando vulnerabilidades...</div>
            <table id="vulnerabilidadesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Protocolo</th>
                        <th>Criticidad</th>
                        <th>Estado</th>
                        <th>DescripciÃ³n</th>
                        <th>Fecha</th>
                        <th>Responsable</th>
                        <th>Usuario Asignado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="vulnerabilidadesBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let token = null;
        let currentEditId = null;

        // Verificar estado del servidor
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/protocolos');
                document.getElementById('serverStatus').className = response.ok ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
                document.getElementById('serverStatusText').textContent = response.ok ? 'Conectado âœ“' : 'Desconectado âœ—';
                return response.ok;
            } catch {
                document.getElementById('serverStatus').className = 'status-indicator status-disconnected';
                document.getElementById('serverStatusText').textContent = 'Desconectado âœ—';
                return false;
            }
        }

        // Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showLoginAlert('Complete todos los campos', 'danger');
                return;
            }
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, contraseÃ±a: password })
                });
                const result = await response.json();
                if (response.ok && result.token) {
                    token = result.token;
                    localStorage.setItem('token', token);
                    showLoginAlert('Login exitoso!', 'success');
                    setTimeout(() => {
                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('mainSection').classList.remove('hidden');
                        inicializarAplicacion();
                    }, 1000);
                } else {
                    showLoginAlert(result.error || 'Credenciales invÃ¡lidas', 'danger');
                }
            } catch (error) {
                showLoginAlert('Error de conexiÃ³n', 'danger');
                console.error(error);
            }
        }

        // Logout
        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('loginAlert').innerHTML = '';
            showLoginAlert('SesiÃ³n cerrada', 'success');
        }

        // Alertas
        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertContainer');
            alert.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        // Cargar datos de referencia
        async function cargarDatosReferencia() {
            try {
                const [protocolos, criticidades, estados, usuarios] = await Promise.all([
                    fetch('/api/protocolos').then(r => r.json()),
                    fetch('/api/criticidades').then(r => r.json()),
                    fetch('/api/estados').then(r => r.json()),
                    fetch('/api/usuarios', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
                ]);
                [protocolos, criticidades, estados, usuarios].forEach((data, i) => {
                    const select = ['id_protocolo', 'id_criticidad', 'id_estado', 'id_usuario_asignado'][i];
                    document.getElementById(select).innerHTML = '<option value="">Seleccionar...</option>' + data.map(item => `<option value="${item.id || item.id_usuario}">${item.nombre || item.nivel || item.email}</option>`).join('');
                });
            } catch (error) {
                showAlert('Error al cargar datos de referencia', 'danger');
                console.error(error);
            }
        }

        // Cargar vulnerabilidades
        async function cargarVulnerabilidades() {
            if (!token) {
                showAlert('SesiÃ³n invÃ¡lida', 'danger');
                logout();
                return;
            }
            const loading = document.getElementById('loading');
            const table = document.getElementById('vulnerabilidadesTable');
            loading.style.display = 'block';
            table.style.display = 'none';
            try {
                const response = await fetch('/api/vulnerabilidades', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Error en la peticiÃ³n');
                const vulnerabilidades = await response.json();
                const tbody = document.getElementById('vulnerabilidadesBody');
                tbody.innerHTML = vulnerabilidades.map(v => `
                    <tr>
                        <td>${v.id_vulnerabilidad}</td>
                        <td>${v.protocolo_nombre || 'Desconocido'}</td>
                        <td>${v.criticidad_nombre}</td>
                        <td>${v.estado_nombre}</td>
                        <td title="${v.descripcion}">${v.descripcion.substring(0, 50)}${v.descripcion.length > 50 ? '...' : ''}</td>
                        <td>${v.fecha_identificacion}</td>
                        <td>${v.responsable || 'Sin asignar'}</td>
                        <td>${v.usuario_nombre || 'Sin asignar'}</td>
                        <td>
                            <button class="btn-small btn-warning" onclick="editarVulnerabilidad(${v.id_vulnerabilidad})">âœï¸</button>
                            <button class="btn-small btn-danger" onclick="eliminarVulnerabilidad(${v.id_vulnerabilidad})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');
                loading.style.display = 'none';
                table.style.display = 'table';
                if (vulnerabilidades.length === 0) tbody.innerHTML = '<tr><td colspan="9">No hay vulnerabilidades</td></tr>';
            } catch (error) {
                console.error(error);
                showAlert('Error al cargar vulnerabilidades', 'danger');
                loading.style.display = 'none';
            }
        }

        // Eliminar vulnerabilidad
        async function eliminarVulnerabilidad(id) {
            if (!confirm('Â¿Eliminar vulnerabilidad?')) return;
            try {
                const response = await fetch(`/api/vulnerabilidades/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    showAlert('Vulnerabilidad eliminada', 'success');
                    cargarVulnerabilidades();
                } else {
                    const error = await response.json();
                    showAlert(error.error, 'danger');
                }
            } catch (error) {
                showAlert('Error al eliminar', 'danger');
                console.error(error);
            }
        }

        // Editar vulnerabilidad
        async function editarVulnerabilidad(id) {
            try {
                const response = await fetch(`/api/vulnerabilidades/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Error al obtener datos');
                const vuln = await response.json();
                currentEditId = id;
                ['id_protocolo', 'id_criticidad', 'id_estado', 'descripcion', 'fecha_identificacion', 'responsable', 'id_usuario_asignado']
                    .forEach(field => document.getElementById(field).value = vuln[field] || (field === 'id_usuario_asignado' ? '' : vuln[field]));
                document.querySelector('#vulnerabilidadForm button').textContent = 'ğŸš€ Actualizar Vulnerabilidad';
            } catch (error) {
                showAlert('Error al cargar datos para ediciÃ³n', 'danger');
                console.error(error);
            }
        }

        // Manejo del formulario
        document.getElementById('vulnerabilidadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                id_protocolo: document.getElementById('id_protocolo').value,
                id_criticidad: document.getElementById('id_criticidad').value,
                id_estado: document.getElementById('id_estado').value,
                descripcion: document.getElementById('descripcion').value,
                fecha_identificacion: document.getElementById('fecha_identificacion').value,
                responsable: document.getElementById('responsable').value,
                id_usuario_asignado: document.getElementById('id_usuario_asignado').value || null
            };
            const url = currentEditId ? `/api/vulnerabilidades/${currentEditId}` : '/api/vulnerabilidades';
            const method = currentEditId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(`Vulnerabilidad ${currentEditId ? 'actualizada' : 'creada'} con ID: ${result.id || currentEditId}`, 'success');
                    document.getElementById('vulnerabilidadForm').reset();
                    document.getElementById('fecha_identificacion').value = new Date().toISOString().split('T')[0];
                    document.querySelector('#vulnerabilidadForm button').textContent = 'ğŸš€ Crear/Actualizar Vulnerabilidad';
                    currentEditId = null;
                    cargarVulnerabilidades();
                } else {
                    showAlert(result.error || 'Error en la operaciÃ³n', 'danger');
                }
            } catch (error) {
                showAlert('Error en la operaciÃ³n', 'danger');
                console.error(error);
            }
        });

        // Inicializar aplicaciÃ³n
        async function inicializarAplicacion() {
            await cargarDatosReferencia();
            await cargarVulnerabilidades();
            document.getElementById('fecha_identificacion').value = new Date().toISOString().split('T')[0];
            setInterval(cargarVulnerabilidades, 30000); // Refresco cada 30 segundos
        }

        // Event listeners para Enter en login
        ['loginEmail', 'loginPassword'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => e.key === 'Enter' && login());
        });

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', async () => {
            await checkServerStatus();
            const storedToken = localStorage.getItem('token');
            if (storedToken) {
                token = storedToken;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                await inicializarAplicacion();
            }
        });
    </script>
</body>
</html>