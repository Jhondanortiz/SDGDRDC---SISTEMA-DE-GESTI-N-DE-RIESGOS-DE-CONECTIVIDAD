<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDGDRDC - Sistema de Gesti√≥n de Riesgos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        // Declaraci√≥n global de token
        window.token = localStorage.getItem('token') || null;
    </script>
</head>
<body>
    <header>
        <h1 class="logo">üîê SDGDRDC</h1>
    </header>
    <main>
        <!-- Secci√≥n de Login -->
        <section class="container" id="loginSection" aria-live="polite">
            <h2>Inicio de Sesi√≥n</h2>
            <div class="login-section" role="form">
                <div id="loginAlert"></div>
                <div class="form-group">
                    <label for="loginEmail">üìß Email:</label>
                    <input type="email" id="loginEmail" value="admin@uniminuto.edu" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="loginPassword">üîë Contrase√±a:</label>
                    <input type="password" id="loginPassword" value="admin123" required aria-required="true">
                </div>
                <button type="button" onclick="login()" class="btn btn-primary" aria-label="Iniciar Sesi√≥n">üöÄ Iniciar Sesi√≥n</button>
                <div class="status">
                    <small>Estado del servidor: <span class="status-indicator" id="serverStatus"></span><span id="serverStatusText">Verificando...</span></small>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Principal -->
        <section class="container hidden" id="mainSection" aria-live="polite">
            <header class="main-header">
                <h2>üìä Sistema de Gesti√≥n de Riesgos de Conectividad</h2>
                <div class="nav-buttons">
                    <button onclick="loadSection('dashboard')" class="btn btn-small btn-warning" aria-label="Ir al Dashboard">üìà Dashboard</button>
                    <button onclick="loadSection('reports')" class="btn btn-small btn-warning" aria-label="Ver Reportes">üìã Reportes</button>
                    <button type="button" onclick="logout()" class="btn btn-danger" aria-label="Cerrar Sesi√≥n">üö™ Cerrar Sesi√≥n</button>
                </div>
            </header>
            
            <div id="alertContainer" role="alert"></div>
            
            <section class="form-section" id="vulnerabilitiesFormSection">
                <h3>‚ûï Crear/Actualizar Vulnerabilidad</h3>
                <form id="vulnerabilidadForm" aria-label="Formulario de Vulnerabilidad">
                    <div class="form-group">
                        <label for="id_protocolo">üîó Protocolo:</label>
                        <select name="id_protocolo" id="id_protocolo" class="form-control" required aria-required="true">
                            <option value="">Seleccionar protocolo...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_criticidad">‚ö†Ô∏è Criticidad:</label>
                        <select name="id_criticidad" id="id_criticidad" class="form-control" required aria-required="true">
                            <option value="">Seleccionar criticidad...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_estado">üìã Estado:</label>
                        <select name="id_estado" id="id_estado" class="form-control" required aria-required="true">
                            <option value="">Seleccionar estado...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">üìù Descripci√≥n:</label>
                        <textarea name="descripcion" id="descripcion" class="form-control" maxlength="500" placeholder="Describa detalladamente (m√°x. 500 caracteres)..." required aria-required="true"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fecha_identificacion">üìÖ Fecha de Identificaci√≥n:</label>
                        <input type="date" name="fecha_identificacion" id="fecha_identificacion" class="form-control" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="responsable">üë§ Responsable:</label>
                        <input type="text" name="responsable" id="responsable" class="form-control" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="id_usuario_asignado">üë• Usuario Asignado:</label>
                        <select name="id_usuario_asignado" id="id_usuario_asignado" class="form-control">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" aria-label="Crear o Actualizar Vulnerabilidad">üöÄ Crear/Actualizar Vulnerabilidad</button>
                </form>
            </section>

            <section class="vulnerabilities-section" id="vulnerabilitiesSection">
                <h3>üìä Lista de Vulnerabilidades</h3>
                <div class="loading" id="loading" aria-live="polite">Cargando vulnerabilidades...</div>
                <table id="vulnerabilidadesTable" class="table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Protocolo</th>
                            <th>Criticidad</th>
                            <th>Estado</th>
                            <th>Descripci√≥n</th>
                            <th>Fecha</th>
                            <th>Responsable</th>
                            <th>Usuario Asignado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="vulnerabilidadesBody"></tbody>
                </table>
                <div id="dynamicContent" class="content-section"></div>
            </section>
        </section>
    </main>

    <script>
        let currentEditId = null;

        async function checkServerStatus() {
            try {
                const response = await fetch('/api/protocolos');
                const statusElement = document.getElementById('serverStatus');
                const textElement = document.getElementById('serverStatusText');
                if (statusElement && textElement) {
                    statusElement.className = response.ok ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
                    textElement.textContent = response.ok ? 'Conectado ‚úì' : 'Desconectado ‚úó';
                }
                return response.ok;
            } catch (error) {
                console.error('Verificaci√≥n del estado del servidor fall√≥, reintentando...', error);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return await checkServerStatus();
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showLoginAlert('Complete todos los campos', 'danger');
                return;
            }
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                console.log('Respuesta de login:', result);
                if (response.ok && result.token) {
                    window.token = result.token;
                    localStorage.setItem('token', window.token);
                    console.log('Token guardado:', window.token.substring(0, 10) + '...');
                    showLoginAlert('¬°Inicio de sesi√≥n exitoso!', 'success');
                    setTimeout(() => {
                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('mainSection').classList.remove('hidden');
                        inicializarAplicacion();
                    }, 1000);
                } else {
                    showLoginAlert(result.error || 'Credenciales inv√°lidas', 'danger');
                }
            } catch (error) {
                console.error('Error en el login:', error);
                showLoginAlert('Error de conexi√≥n', 'danger');
            }
        }

        function logout() {
            window.token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('loginAlert').innerHTML = '';
            document.getElementById('alertContainer').innerHTML = '';
            document.getElementById('dynamicContent').innerHTML = '';
            showLoginAlert('Sesi√≥n cerrada', 'success');
        }

        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            if (alert) {
                alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alert.innerHTML = '', 5000);
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertContainer');
            if (alert) {
                alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alert.innerHTML = '', 5000);
            }
        }

        async function verifyToken() {
            if (!window.token) {
                console.log('No hay token disponible');
                return false;
            }
            try {
                const response = await fetch('/api/verify-token', {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                console.log('Respuesta de verificaci√≥n de token:', response.status);
                if (response.status === 401) {
                    logout();
                    return false;
                }
                const data = await response.json();
                if (!data.valid) {
                    if (data.message !== 'No autenticado, usa /login para obtener un token') {
                        logout();
                    }
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Fallo en la verificaci√≥n del token:', error);
                return false;
            }
        }

        async function cargarDatosReferencia() {
            if (!await verifyToken()) return;
            try {
                const [protocolos, criticidades, estados] = await Promise.all([
                    fetch('/api/protocolos').then(r => r.json()),
                    fetch('/api/criticidades').then(r => r.json()),
                    fetch('/api/estados').then(r => r.json())
                ]);
                const selects = {
                    'id_protocolo': protocolos.map(p => `<option value="${p.id_protocolo}">${p.nombre}</option>`),
                    'id_criticidad': criticidades.map(c => `<option value="${c.id_criticidad}">${c.nivel}</option>`),
                    'id_estado': estados.map(e => `<option value="${e.id_estado}">${e.nombre}</option>`)
                };
                if (await verifyToken()) {
                    const usuariosResponse = await fetch('/api/usuarios', {
                        headers: { 'Authorization': `Bearer ${window.token}` }
                    });
                    if (usuariosResponse.ok) {
                        const usuarios = await usuariosResponse.json();
                        selects['id_usuario_asignado'] = usuarios.map(u => `<option value="${u.id_usuario}">${u.nombre} (${u.email})</option>`).join('');
                    }
                }
                Object.entries(selects).forEach(([id, options]) => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">Seleccionar...</option>' + (options || '');
                    }
                });
            } catch (error) {
                console.error('Error al cargar datos de referencia:', error);
                showAlert(`Error al cargar datos: ${error.message}`, 'danger');
            }
        }

        async function cargarVulnerabilidades() {
            if (!await verifyToken()) return;
            const loading = document.getElementById('loading');
            const table = document.getElementById('vulnerabilidadesTable');
            if (loading && table) {
                loading.style.display = 'block';
                table.style.display = 'none';
            }
            try {
                const response = await fetch('/api/vulnerabilidades', {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                if (response.status === 401) {
                    logout();
                    return;
                }
                if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
                const vulnerabilidades = await response.json();
                const tbody = document.getElementById('vulnerabilidadesBody');
                if (tbody && table) {
                    tbody.innerHTML = vulnerabilidades.map(v => `
                        <tr>
                            <td>${v.id_vulnerabilidad || 'N/A'}</td>
                            <td>${v.protocolo_nombre || 'Desconocido'}</td>
                            <td><span class="criticidad-${(v.criticidad_nombre || '').toLowerCase().replace(' ', '-')}">${v.criticidad_nombre || 'Sin asignar'}</span></td>
                            <td><span class="estado-${(v.estado_nombre || '').toLowerCase().replace(' ', '-')}">${v.estado_nombre || 'Sin asignar'}</span></td>
                            <td title="${v.descripcion || ''}">${(v.descripcion || '').substring(0, 50)}${(v.descripcion || '').length > 50 ? '...' : ''}</td>
                            <td>${v.fecha_identificacion || 'N/A'}</td>
                            <td>${v.responsable || 'Sin asignar'}</td>
                            <td>${v.usuario_nombre || 'Sin asignar'}</td>
                            <td>
                                <button class="btn-small btn-warning" onclick="editarVulnerabilidad(${v.id_vulnerabilidad})" aria-label="Editar">‚úèÔ∏è</button>
                                <button class="btn-small btn-danger" onclick="eliminarVulnerabilidad(${v.id_vulnerabilidad})" aria-label="Eliminar">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                    loading.style.display = 'none';
                    table.style.display = 'table';
                    if (vulnerabilidades.length === 0) tbody.innerHTML = '<tr><td colspan="9">No hay vulnerabilidades</td></tr>';
                }
            } catch (error) {
                console.error('Error al cargar vulnerabilidades:', error);
                if (loading) loading.style.display = 'none';
                showAlert(`Error al cargar vulnerabilidades: ${error.message}`, 'danger');
            }
        }

        async function eliminarVulnerabilidad(id) {
            if (!await verifyToken()) return;
            if (!confirm('¬øEliminar vulnerabilidad?')) return;
            try {
                const response = await fetch(`/api/vulnerabilidades/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                if (response.ok) {
                    showAlert('Vulnerabilidad eliminada', 'success');
                    cargarVulnerabilidades();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Error al eliminar', 'danger');
                }
            } catch (error) {
                console.error('Error al eliminar vulnerabilidad:', error);
                showAlert('Error al eliminar', 'danger');
            }
        }

        async function editarVulnerabilidad(id) {
            if (!await verifyToken()) return;
            try {
                const response = await fetch(`/api/vulnerabilidades/${id}`, {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
                const vuln = await response.json();
                currentEditId = id;
                const fields = ['id_protocolo', 'id_criticidad', 'id_estado', 'descripcion', 'fecha_identificacion', 'responsable', 'id_usuario_asignado'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) element.value = vuln[field] || (field === 'fecha_identificacion' ? new Date(vuln.fecha_identificacion).toISOString().split('T')[0] : '');
                });
                const submitButton = document.querySelector('#vulnerabilidadForm button[type="submit"]');
                if (submitButton) submitButton.textContent = 'üöÄ Actualizar Vulnerabilidad';
            } catch (error) {
                console.error('Error al editar vulnerabilidad:', error);
                showAlert(`Error al cargar datos: ${error.message}`, 'danger');
            }
        }

        document.getElementById('vulnerabilidadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!await verifyToken()) return;
            const data = {
                id_protocolo: document.getElementById('id_protocolo').value,
                id_criticidad: document.getElementById('id_criticidad').value,
                id_estado: document.getElementById('id_estado').value,
                descripcion: document.getElementById('descripcion').value.trim(),
                fecha_identificacion: document.getElementById('fecha_identificacion').value,
                responsable: document.getElementById('responsable').value.trim() || null,
                id_usuario_asignado: document.getElementById('id_usuario_asignado').value || null
            };
            if (!data.id_protocolo || !data.id_criticidad || !data.id_estado || !data.descripcion || !data.fecha_identificacion) {
                showAlert('Complete todos los campos obligatorios', 'danger');
                return;
            }
            const url = currentEditId ? `/api/vulnerabilidades/${currentEditId}` : '/api/vulnerabilidades';
            const method = currentEditId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Authorization': `Bearer ${window.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(`Vulnerabilidad ${currentEditId ? 'actualizada' : 'creada'} con ID: ${result.id || currentEditId}`, 'success');
                    document.getElementById('vulnerabilidadForm').reset();
                    document.getElementById('fecha_identificacion').value = new Date().toISOString().split('T')[0];
                    const submitButton = document.querySelector('#vulnerabilidadForm button[type="submit"]');
                    if (submitButton) submitButton.textContent = 'üöÄ Crear/Actualizar Vulnerabilidad';
                    currentEditId = null;
                    cargarVulnerabilidades();
                } else {
                    showAlert(result.error || 'Error en la operaci√≥n', 'danger');
                }
            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                showAlert('Error en la operaci√≥n', 'danger');
            }
        });

        async function loadSection(section) {
            console.log('Cargando secci√≥n:', section, 'con token:', window.token ? 'presente' : 'ausente');
            if (!await verifyToken()) {
                console.log('Fallo en la verificaci√≥n del token para:', section);
                return;
            }
            const contentDiv = document.getElementById('dynamicContent');
            if (!contentDiv) {
                console.error('Div de contenido din√°mico no encontrado');
                showAlert('Error al cargar la secci√≥n. Recargue la p√°gina.', 'danger');
                return;
            }
            contentDiv.classList.add('loading');
            contentDiv.innerHTML = '<div class="loading">Cargando...</div>';
            try {
                const response = await fetch(`/${section}`, {
                    headers: { 'Authorization': `Bearer ${window.token}` }
                });
                console.log('Respuesta de fetch para', section, ':', response.status);
                if (response.ok) {
                    const html = await response.text();
                    console.log('HTML recibido para', section, ':', html.substring(0, 100));
                    contentDiv.innerHTML = html;
                    // Ejecutar scripts din√°micos sin redeclarar variables globales
                    const scripts = contentDiv.getElementsByTagName('script');
                    for (let script of scripts) {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent.replace(/let\s+token\s*=\s*localStorage\.getItem\('token'\)\s*\|\|\s*null;/g, '');
                        }
                        document.head.appendChild(newScript);
                    }
                    // Llamar a funciones de inicializaci√≥n si existen
                    if (window.initializeDashboard && section === 'dashboard') {
                        initializeDashboard();
                    }
                    if (window.initializeReports && section === 'reports') {
                        initializeReports();
                    }
                    contentDiv.style.display = 'block';
                } else if (response.status === 401) {
                    logout();
                } else {
                    contentDiv.innerHTML = `<div class="alert alert-danger">Error al cargar ${section}. C√≥digo: ${response.status}</div>`;
                    contentDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cargar', section, ':', error);
                contentDiv.innerHTML = '<div class="alert alert-danger">Error de conexi√≥n. Verifica el servidor.</div>';
                contentDiv.style.display = 'block';
            } finally {
                contentDiv.classList.remove('loading');
            }
        }

        async function inicializarAplicacion() {
            if (!await verifyToken()) return;
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                await cargarDatosReferencia();
                await cargarVulnerabilidades();
                const fechaInput = document.getElementById('fecha_identificacion');
                if (fechaInput) fechaInput.value = new Date().toISOString().split('T')[0];
                setInterval(() => { if (window.token) cargarVulnerabilidades(); }, 30000);
                setInterval(checkServerStatus, 30000);
            } catch (error) {
                console.error('Error de inicializaci√≥n:', error);
                showAlert('Error al inicializar la aplicaci√≥n', 'danger');
            }
        }

        ['loginEmail', 'loginPassword'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login();
                });
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await checkServerStatus();
            if (window.token) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                await inicializarAplicacion();
            }
        });
    </script>
</body>
</html>