<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDGDRDC - Sistema de Gestión de Riesgos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Sección de Login -->
    <div class="container" id="loginSection">
        <h1>🔐 SDGDRDC - Inicio de Sesión</h1>
        <div class="login-section">
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="loginEmail">📧 Email:</label>
                <input type="email" id="loginEmail" value="admin@uniminuto.edu" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">🔑 Contraseña:</label>
                <input type="password" id="loginPassword" value="admin123" required>
            </div>
            <button onclick="login()">🚀 Iniciar Sesión</button>
            <div style="margin-top: 10px;">
                <small>Estado del servidor: <span class="status-indicator" id="serverStatus"></span><span id="serverStatusText">Verificando...</span></small>
            </div>
        </div>
    </div>

    <!-- Sección Principal -->
    <div class="container hidden" id="mainSection">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>📊 SDGDRDC - Sistema de Gestión de Riesgos de Conectividad</h1>
            <div>
                <button onclick="window.location.href='/dashboard'" class="btn btn-small btn-warning">📈 Dashboard</button>
                <button onclick="window.location.href='/reports'" class="btn btn-small btn-warning">📋 Reportes</button>
                <button onclick="logout()" class="btn btn-danger">🚪 Cerrar Sesión</button>
            </div>
        </div>
        
        <div id="alertContainer"></div>
        
        <h2>➕ Crear/Actualizar Vulnerabilidad</h2>
        <form id="vulnerabilidadForm">
            <div class="form-group">
                <label for="id_protocolo">🔗 Protocolo:</label>
                <select name="id_protocolo" id="id_protocolo" class="form-control" required>
                    <option value="">Seleccionar protocolo...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="id_criticidad">⚠️ Criticidad:</label>
                <select name="id_criticidad" id="id_criticidad" class="form-control" required>
                    <option value="">Seleccionar criticidad...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="id_estado">📋 Estado:</label>
                <select name="id_estado" id="id_estado" class="form-control" required>
                    <option value="">Seleccionar estado...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="descripcion">📝 Descripción:</label>
                <textarea name="descripcion" id="descripcion" class="form-control" maxlength="500" placeholder="Describa detalladamente (máx. 500 caracteres)..." required></textarea>
            </div>
            <div class="form-group">
                <label for="fecha_identificacion">📅 Fecha de Identificación:</label>
                <input type="date" name="fecha_identificacion" id="fecha_identificacion" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="responsable">👤 Responsable:</label>
                <input type="text" name="responsable" id="responsable" class="form-control" maxlength="100">
            </div>
            <div class="form-group">
                <label for="id_usuario_asignado">👥 Usuario Asignado:</label>
                <select name="id_usuario_asignado" id="id_usuario_asignado" class="form-control">
                    <option value="">Sin asignar</option>
                </select>
            </div>
            <button type="submit" class="btn">🚀 Crear/Actualizar Vulnerabilidad</button>
        </form>

        <div class="container" id="vulnerabilidadesSection">
            <h2>📊 Lista de Vulnerabilidades</h2>
            <div class="loading" id="loading">Cargando vulnerabilidades...</div>
            <table id="vulnerabilidadesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Protocolo</th>
                        <th>Criticidad</th>
                        <th>Estado</th>
                        <th>Descripción</th>
                        <th>Fecha</th>
                        <th>Responsable</th>
                        <th>Usuario Asignado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="vulnerabilidadesBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let token = null;
        let currentEditId = null;

        // Verificar estado del servidor
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/protocolos');
                document.getElementById('serverStatus').className = response.ok ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
                document.getElementById('serverStatusText').textContent = response.ok ? 'Conectado ✓' : 'Desconectado ✗';
                return response.ok;
            } catch {
                document.getElementById('serverStatus').className = 'status-indicator status-disconnected';
                document.getElementById('serverStatusText').textContent = 'Desconectado ✗';
                return false;
            }
        }

        // Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showLoginAlert('Complete todos los campos', 'danger');
                return;
            }
            try {
                console.log('Attempting login with email:', email);
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, contraseña: password })
                });
                const result = await response.json();
                console.log('Login response:', response.status, result);
                if (response.ok && result.token) {
                    token = result.token;
                    localStorage.setItem('token', token);
                    showLoginAlert('Login exitoso!', 'success');
                    setTimeout(() => {
                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('mainSection').classList.remove('hidden');
                        inicializarAplicacion();
                    }, 1000);
                } else {
                    showLoginAlert(result.error || 'Credenciales inválidas', 'danger');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginAlert('Error de conexión', 'danger');
            }
        }

        // Logout
        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('loginAlert').innerHTML = '';
            document.getElementById('alertContainer').innerHTML = '';
            showLoginAlert('Sesión cerrada', 'success');
        }

        // Alertas
        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertContainer');
            alert.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        // Verificar token
        async function verifyToken() {
            if (!token) return false;
            try {
                const response = await fetch('/api/verify-token', { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status === 401) {
                    logout();
                    return false;
                }
                if (!response.ok) throw new Error(`Error en verificación: ${response.status}`);
                return true;
            } catch (error) {
                console.error('Token verification error:', error);
                logout();
                return false;
            }
        }

        // Cargar datos de referencia
        async function cargarDatosReferencia() {
            if (!await verifyToken()) return;
            try {
                const [protocolos, criticidades, estados] = await Promise.all([
                    fetch('/api/protocolos').then(r => r.json()),
                    fetch('/api/criticidades').then(r => r.json()),
                    fetch('/api/estados').then(r => r.json())
                ]);
                const selects = {
                    'id_protocolo': protocolos.map(p => `<option value="${p.id_protocolo}">${p.nombre}</option>`),
                    'id_criticidad': criticidades.map(c => `<option value="${c.id_criticidad}">${c.nivel}</option>`),
                    'id_estado': estados.map(e => `<option value="${e.id_estado}">${e.nombre}</option>`)
                };
                if (await verifyToken()) {
                    const usuariosResponse = await fetch('/api/usuarios', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (usuariosResponse.ok) {
                        const usuarios = await usuariosResponse.json();
                        selects['id_usuario_asignado'] = usuarios.map(u => `<option value="${u.id_usuario}">${u.nombre} (${u.email})</option>`).join('');
                    } else if (usuariosResponse.status === 401) {
                        logout();
                        return;
                    }
                }
                Object.entries(selects).forEach(([id, options]) => {
                    const select = document.getElementById(id);
                    select.innerHTML = '<option value="">Seleccionar...</option>' + (options || '');
                });
            } catch (error) {
                console.error('Error loading reference data:', error);
                showAlert(`Error al cargar datos de referencia: ${error.message}`, 'danger');
            }
        }

        // Cargar vulnerabilidades
        async function cargarVulnerabilidades() {
            if (!await verifyToken()) return;
            const loading = document.getElementById('loading');
            const table = document.getElementById('vulnerabilidadesTable');
            loading.style.display = 'block';
            table.style.display = 'none';
            try {
                console.log('Fetching vulnerabilities with token:', token.substring(0, 10) + '...');
                const response = await fetch('/api/vulnerabilidades', { 
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } 
                });
                console.log('API response status:', response.status);
                if (response.status === 401) {
                    logout();
                    return;
                }
                if (!response.ok) throw new Error(`Error en la petición: ${response.status}`);
                const vulnerabilidades = await response.json();
                console.log('Vulnerabilities fetched:', vulnerabilidades.length);
                const tbody = document.getElementById('vulnerabilidadesBody');
                tbody.innerHTML = vulnerabilidades.map(v => `
                    <tr>
                        <td>${v.id_vulnerabilidad || 'N/A'}</td>
                        <td>${v.protocolo_nombre || 'Desconocido'}</td>
                        <td><span class="criticidad-${(v.criticidad_nombre || '').toLowerCase().replace(' ', '-')}">${v.criticidad_nombre || 'Sin asignar'}</span></td>
                        <td><span class="estado-${(v.estado_nombre || '').toLowerCase().replace(' ', '-')}">${v.estado_nombre || 'Sin asignar'}</span></td>
                        <td title="${v.descripcion || ''}">${(v.descripcion || '').substring(0, 50)}${(v.descripcion || '').length > 50 ? '...' : ''}</td>
                        <td>${v.fecha_identificacion || 'N/A'}</td>
                        <td>${v.responsable || 'Sin asignar'}</td>
                        <td>${v.usuario_nombre || 'Sin asignar'}</td>
                        <td>
                            <button class="btn-small btn-warning" onclick="editarVulnerabilidad(${v.id_vulnerabilidad})">✏️</button>
                            <button class="btn-small btn-danger" onclick="eliminarVulnerabilidad(${v.id_vulnerabilidad})">🗑️</button>
                        </td>
                    </tr>
                `).join('');
                loading.style.display = 'none';
                table.style.display = 'table';
                if (vulnerabilidades.length === 0) tbody.innerHTML = '<tr><td colspan="9">No hay vulnerabilidades</td></tr>';
            } catch (error) {
                console.error('Error loading vulnerabilities:', error);
                loading.style.display = 'none';
                showAlert(`Error al cargar vulnerabilidades: ${error.message}`, 'danger');
            }
        }

        // Eliminar vulnerabilidad
        async function eliminarVulnerabilidad(id) {
            if (!await verifyToken()) return;
            if (!confirm('¿Eliminar vulnerabilidad?')) return;
            try {
                console.log('Deleting vulnerability ID:', id);
                const response = await fetch(`/api/vulnerabilidades/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                console.log('Delete response status:', response.status);
                if (response.ok) {
                    showAlert('Vulnerabilidad eliminada', 'success');
                    cargarVulnerabilidades();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Error al eliminar la vulnerabilidad', 'danger');
                }
            } catch (error) {
                console.error('Error deleting vulnerability:', error);
                showAlert('Error al eliminar', 'danger');
            }
        }

        // Editar vulnerabilidad
        async function editarVulnerabilidad(id) {
            if (!await verifyToken()) return;
            try {
                console.log('Fetching vulnerability ID:', id);
                const response = await fetch(`/api/vulnerabilidades/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error(`Error al obtener datos: ${response.status}`);
                const vuln = await response.json();
                currentEditId = id;
                document.getElementById('id_protocolo').value = vuln.id_protocolo || '';
                document.getElementById('id_criticidad').value = vuln.id_criticidad || '';
                document.getElementById('id_estado').value = vuln.id_estado || '';
                document.getElementById('descripcion').value = vuln.descripcion || '';
                document.getElementById('fecha_identificacion').value = vuln.fecha_identificacion || new Date().toISOString().split('T')[0];
                document.getElementById('responsable').value = vuln.responsable || '';
                document.getElementById('id_usuario_asignado').value = vuln.id_usuario_asignado || '';
                document.querySelector('#vulnerabilidadForm button').textContent = '🚀 Actualizar Vulnerabilidad';
            } catch (error) {
                console.error('Error editing vulnerability:', error);
                showAlert(`Error al cargar datos para edición: ${error.message}`, 'danger');
            }
        }

        // Manejo del formulario
        document.getElementById('vulnerabilidadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!await verifyToken()) return;
            const data = {
                id_protocolo: document.getElementById('id_protocolo').value || null,
                id_criticidad: document.getElementById('id_criticidad').value || null,
                id_estado: document.getElementById('id_estado').value || null,
                descripcion: document.getElementById('descripcion').value.trim() || null,
                fecha_identificacion: document.getElementById('fecha_identificacion').value || null,
                responsable: document.getElementById('responsable').value.trim() || null,
                id_usuario_asignado: document.getElementById('id_usuario_asignado').value || null
            };
            if (!data.id_protocolo || !data.id_criticidad || !data.id_estado || !data.descripcion || !data.fecha_identificacion) {
                showAlert('Complete todos los campos obligatorios', 'danger');
                return;
            }
            const url = currentEditId ? `/api/vulnerabilidades/${currentEditId}` : '/api/vulnerabilidades';
            const method = currentEditId ? 'PUT' : 'POST';

            try {
                console.log('Submitting form with method:', method, 'data:', data);
                const response = await fetch(url, {
                    method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Form response:', response.status, result);
                if (response.ok) {
                    showAlert(`Vulnerabilidad ${currentEditId ? 'actualizada' : 'creada'} con ID: ${result.id || currentEditId}`, 'success');
                    document.getElementById('vulnerabilidadForm').reset();
                    document.getElementById('fecha_identificacion').value = new Date().toISOString().split('T')[0];
                    document.querySelector('#vulnerabilidadForm button').textContent = '🚀 Crear/Actualizar Vulnerabilidad';
                    currentEditId = null;
                    cargarVulnerabilidades();
                } else {
                    showAlert(result.error || 'Error en la operación', 'danger');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                showAlert('Error en la operación', 'danger');
            }
        });

        // Inicializar aplicación
        async function inicializarAplicacion() {
            if (!await verifyToken()) return;
            try {
                await cargarDatosReferencia();
                await cargarVulnerabilidades();
                document.getElementById('fecha_identificacion').value = new Date().toISOString().split('T')[0];
                const intervalId = setInterval(() => {
                    if (token) cargarVulnerabilidades();
                    else clearInterval(intervalId);
                }, 30000);
                setInterval(checkServerStatus, 30000);
            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Error al inicializar la aplicación', 'danger');
            }
        }

        // Event listeners para Enter en login
        ['loginEmail', 'loginPassword'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => e.key === 'Enter' && login());
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, checking server status');
            await checkServerStatus();
            const storedToken = localStorage.getItem('token');
            if (storedToken) {
                token = storedToken;
                console.log('Using stored token:', token.substring(0, 10) + '...');
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                await inicializarAplicacion();
            }
        });
    </script>
</body>
</html>